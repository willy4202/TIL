# 웹브라우저 동작 원리

코드를 잘 짜기 위해선 브라우저 동작 원리에 대해 아는 것이 좋다.

자바스크립트는 조금 특이한 방식으로 동작한다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/6dcf5c33-02ed-465b-9842-573a1ba42014/Untitled.png)

자바스크립트는 위에적든 밑에 적든 빠른 것부터 실행해줍니다.

웹 브라우저는 `stack`이라는 공간에 코드를 한줄 한줄 올려두고 실행한다.

변수들을 채워두기 위해선 heap을 사용한다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/79b7ccf0-1d46-46a2-a06b-00f0c06c78f0/Untitled.png)

`stack`은 한번에 하나의 코드를 실행하기 때문에 싱글 스레드 언어라고 불린다.

만약 스택에 셋타임아웃과 같은 콜백함수를 인자로 받는 함수를 사용하면

`stack`은 해당 함수를 대기실로 제껴둔다. 이 대기실을 `queue`라고 한다.

- ajax 요청
- 이벤트리스너
- 셋타임아웃 …

시간이 지나 대기실에 있는 것들을 `stack`으로 대려올땐

`queue` 에서 스택으로 하나씩보냅니다.

**_이땐, 스택이 비어있을때만 보냅니다._**

---

이벤트루프는 자바스크립트 엔진이 돌아가면어 문맥의 일부로 동작하는 하나의 장치다.

자바스크립트 엔진이란

- 자바스크립트 코드를 해석하고 실행하는 인터프리터
  - 인터프리터: 코드를 한 줄씩 읽어 내려가며 실행하는 프로그램, 컴파일러와는 대조적이다.
- heap + stack으로 이루어짐
  - heap은 메모리 할당이 일어나는 부분, 주로 변수 객체 등이 저장되는 일종의 창고다.

호출 스택 (call stack)

- 함수가 호출되는 순서대로 쌓이는 스택
- 함수 실행 시 호출 스택에 함수를 집어넣는다.
- 실행이 끝나면 스택의 최상단에 있는 함수를 Pop 시킨다.
- ++ 항상 호출 스택 밑바닥에는 전역 문맥이 존재한다.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/a17a32b1-4121-4657-88d5-d680cf91e40b/Untitled.png)

자바스크립트 엔진

- heap, callstack

브라우저

- webAPI
- JS engine
- Event Loop
- Callback Queue

이벤트 루프는 호출 스택과 콜백 큐를 주시하고 있습니다.

호출 스택이 비어있으면, 먼저 들어온 순서대로 콜백 큐에 있는 콜백 함수들을 호출 스택으로 집어넣습니다.

---

## 마치며

이벤트 루프는 실제로 자바스크립트 언어의 명세보다는 구동 환경과 더 관련된 내용이기 때문에 다른 프로세스들(렌더링, IO 등)과 밀접하게 연관되어 있어 잘 정리된 자료를 찾기가 쉽지만은 않다. 또한 Node.js의 libuv는 HTML 스펙을 완벽히 따르지는 않기 때문에 브라우저 환경의 이벤트 루프와 상세 구현이 조금씩 다르다(심지어 브라우저 별로도 구현이 조금씩 다르다). 또한, 최근에는 ES6에 프라미스와 잡 큐라는 항목이 추가되며 마이크로 태스크의 개념과 혼동되며 이해하기가 한층 더 복잡해졌다. 여기서 끝이 아니다. 사실 이 글에서는 브라우저가 '단일 이벤트 루프'를 사용한다고 가정하고 설명했지만, [웹 워커(Web Worker)](https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers)
는 각각이 독립적인 이벤트 루프를 사용하며([Worker Event Loop](https://html.spec.whatwg.org/multipage/workers.html#worker-event-loop)
라는 이름으로 구분되어 있다), 이와 관련된 내용을 추가한다면 더더욱 복잡해질 것이다. (하아…)

하지만 자바스크립트의 비동기적 특성을 잘 활용하기 위해서는 이벤트 루프를 제대로 이해하는 것이 중요하다. 특히 (이 글에서는 다루지 못했지만) 웹 워커나 [Node.js의 클러스터](https://nodejs.org/api/cluster.html)
를 사용하는 멀티 스레드 환경에서는 이벤트 루프에 대한 탄탄한 이해가 없다면 예상치 못한 버그 앞에 좌절하게 될 지도 모른다. 사실 개인적으로도 계속 스펙문서를 부분 부분 뒤져가며 글을 작성하느라 완벽하게 이해하고 정리하지는 못한 기분이다. 하지만 이 글이 조금이나마 도움이 되었기를 바라며, 여기서 만족하지 말고 관련 링크들을 짬짬이 살펴 보면서 이벤트 루프에 대해 제대로 이해하는 기회가 되었으면 좋겠다.
